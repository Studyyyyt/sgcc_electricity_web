# 🚨 国家电网电费监控系统错误处理预案

## 📋 文档概述

本文档提供了国家电网电费监控系统在部署和运行过程中可能遇到的各种错误情况的详细处理预案。系统由Web服务（sgcc_electricity_web）和Home Assistant集成（sgcc_electricity_client）两部分组成，每部分都有其特定的错误类型和处理方法。

## 🏗️ 系统错误分类

### 错误分级
- 🔴 **严重错误（Critical）**：系统无法启动或完全无法工作
- 🟡 **警告错误（Warning）**：功能受限但系统可继续运行
- 🔵 **信息错误（Info）**：轻微问题，不影响主要功能

---

## 🌐 Web服务错误处理

### 1. 服务启动错误

#### 🔴 Docker容器启动失败
**错误现象：**
```bash
ERROR: Failed to start container
```

**可能原因：**
- Docker服务未运行
- 端口被占用
- 配置文件格式错误
- 权限不足

**处理步骤：**
```bash
# 1. 检查Docker服务状态
sudo systemctl status docker
sudo systemctl start docker

# 2. 检查端口占用
sudo netstat -tlnp | grep 8080
# 如果端口被占用，杀死占用进程或修改配置端口

# 3. 检查配置文件
cd sgcc_electricity_web-0.0.4/sgcc_electricity_web-0.0.4
cat config.yaml | python -m yaml

# 4. 检查文件权限
ls -la config.yaml
sudo chown $USER:$USER config.yaml
```

#### 🔴 配置文件错误
**错误现象：**
```
KeyError: 'electricity'
yaml.scanner.ScannerError: mapping values are not allowed here
```

**处理步骤：**
1. **验证YAML格式：**
```bash
python -c "import yaml; yaml.safe_load(open('config.yaml'))"
```

2. **检查必需配置项：**
```yaml
electricity:
  phone_number: "您的手机号"    # 必需
  password: "您的密码"         # 必需
  # 其他配置项...
db:
  name: "homeassistant.db"     # 必需
logger:
  level: "info"               # 必需
```

3. **修复常见格式错误：**
```yaml
# ❌ 错误格式
electricity:
phone_number: "123456"

# ✅ 正确格式  
electricity:
  phone_number: "123456"
```

### 2. 登录和认证错误

#### 🟡 账号密码错误
**错误现象：**
```
Login failed, maybe caused by invalid captcha
```

**处理步骤：**
1. **验证账号信息：**
   - 手动登录国家电网官网验证账号密码
   - 检查账号是否被锁定
   - 确认手机号格式正确（无空格、特殊字符）

2. **修改配置：**
```yaml
electricity:
  phone_number: "13800138000"  # 确保格式正确
  password: "correct_password"  # 更新正确密码
```

3. **重启服务：**
```bash
docker-compose restart
```

#### 🟡 验证码识别失败
**错误现象：**
```
Sliding CAPTCHA recognition failed and reloaded
```

**处理步骤：**
1. **检查网络连接：**
```bash
# 测试网络连接
curl -I https://www.95598.cn
ping www.95598.cn
```

2. **调整重试参数：**
```yaml
electricity:
  retry_times_limit: 10        # 增加重试次数
  retry_wait_time_offset_unit: 15  # 增加等待时间
```

3. **检查Chrome环境：**
```bash
# 在Docker容器内检查
docker exec -it container_name chromium --version
```

### 3. 数据抓取错误

#### 🟡 户号获取失败
**错误现象：**
```
get user_id list failed
```

**处理步骤：**
1. **检查登录状态：**
   - 确认登录成功
   - 检查会话是否过期

2. **调整等待时间：**
```yaml
electricity:
  deiver_impltcity_wait_time: 120  # 增加等待时间
  login_expected_time: 120
```

3. **检查页面元素变化：**
   - 国家电网可能更新了页面结构
   - 查看项目GitHub是否有更新

#### 🔵 单个户号数据获取失败
**错误现象：**
```
The current user 123456 data fetching failed
```

**处理步骤：**
1. **跳过有问题的户号：**
```yaml
electricity:
  ignore_user_id: 
    - "123456"  # 添加有问题的户号
```

2. **检查户号状态：**
   - 该户号可能已销户
   - 该户号可能欠费被停用

### 4. API接口错误

#### 🔴 API接口无响应
**错误现象：**
```bash
curl: (7) Failed to connect to localhost port 8080
```

**处理步骤：**
```bash
# 1. 检查服务状态
docker-compose ps
docker-compose logs sgcc_electricity_web

# 2. 检查端口绑定
docker port container_name

# 3. 检查防火墙
sudo ufw status
sudo ufw allow 8080

# 4. 重启服务
docker-compose restart
```

#### 🟡 API返回空数据
**错误现象：**
```json
[]
```

**处理步骤：**
1. **检查数据库：**
```bash
# 进入容器检查数据库
docker exec -it container_name sqlite3 /config/homeassistant.db
.tables
SELECT * FROM user_info;
```

2. **手动触发数据抓取：**
```bash
# 查看定时任务日志
docker-compose logs -f sgcc_electricity_web
```

---

## 🏠 Home Assistant集成错误处理

### 1. 集成安装错误

#### 🔴 组件加载失败
**错误现象：**
```
Integration 'sgcc_electricity_client' not found
```

**处理步骤：**
1. **检查文件结构：**
```bash
ls -la /config/custom_components/sgcc_electricity_client/
# 应该包含以下文件：
# __init__.py
# manifest.json
# config_flow.py
# 等...
```

2. **检查文件权限：**
```bash
sudo chown -R homeassistant:homeassistant /config/custom_components/
```

3. **验证manifest.json：**
```bash
cat /config/custom_components/sgcc_electricity_client/manifest.json | python -m json.tool
```

4. **重启Home Assistant**

### 2. 集成配置错误

#### 🟡 no_user 错误
**错误现象：**
- 在HA中添加集成时显示："未查询到内容,请检查国家电网web服务器可正常获取数据"

**根本原因分析：**
- Web服务的用户列表API返回空数组
- Web服务尚未成功抓取到任何用户数据
- Web服务登录失败或数据抓取失败

**详细处理步骤：**

1. **首先检查Web服务状态：**
```bash
# 检查Web服务是否正常运行
curl http://localhost:8080/v1/electricity/user_list

# 预期返回：["户号1", "户号2"] 
# 如果返回：[] 则说明Web服务没有数据
```

2. **检查Web服务日志：**
```bash
# Docker方式
docker-compose logs sgcc_electricity_web | grep -E "(Login|failed|error)"

# Add-on方式
# 在HA中查看Add-on日志
```

3. **可能的根本问题及解决方案：**

   **3a. Web服务登录失败：**
   ```bash
   # 查看登录相关日志
   docker-compose logs sgcc_electricity_web | grep "Login"
   
   # 如果看到登录失败，检查：
   # - 账号密码是否正确
   # - 网络是否能访问国家电网
   # - 验证码识别是否成功
   ```

   **3b. 数据抓取尚未完成：**
   ```bash
   # 检查定时任务状态
   docker-compose logs sgcc_electricity_web | grep "cron\|schedule"
   
   # 手动触发数据抓取（如果支持）
   # 或等待下次定时任务执行（默认7点和19点）
   ```

   **3c. 数据库问题：**
   ```bash
   # 检查数据库是否有数据
   docker exec -it sgcc_electricity_web_container sqlite3 /config/homeassistant.db
   SELECT COUNT(*) FROM user_info;
   .exit
   ```

4. **临时解决方案：**
   - 等待Web服务完成首次数据抓取（可能需要几小时）
   - 检查定时任务设置，确保在合理时间执行
   - 考虑手动重启Web服务触发数据抓取

5. **预防措施：**
   ```yaml
   # 在config.yaml中设置更频繁的数据抓取
   electricity:
     cron_hour: "6,7,18,19"  # 增加抓取频次
   ```

#### 🟡 cannot_connect 错误
**错误现象：**
- 显示："网络异常"

**处理步骤：**
1. **检查网络连通性：**
```bash
# 从HA主机测试连接
curl -I http://localhost:8080
curl -I http://web_service_host:8080
```

2. **检查服务地址格式：**
```
✅ 正确格式：
http://localhost:8080
http://192.168.1.100:8080
https://your-domain.com:8080

❌ 错误格式：
localhost:8080
192.168.1.100
http://localhost
```

3. **检查防火墙和网络：**
```bash
# 检查防火墙规则
sudo ufw status

# 检查端口监听
sudo netstat -tlnp | grep 8080

# 如果Web服务在其他主机，检查网络连通性
ping web_service_host
telnet web_service_host 8080
```

#### 🟡 invalid_format 错误
**错误现象：**
- 显示："请按格式 http(s)://host:port 输入"

**处理步骤：**
1. **确保地址格式正确：**
```
✅ 正确格式示例：
http://localhost:8080
http://192.168.1.100:8080
https://example.com:8080

❌ 常见错误：
localhost:8080          # 缺少协议
http://localhost        # 缺少端口
192.168.1.100:8080     # 缺少协议
http://localhost:8080/  # 多余的斜杠
```

### 3. 传感器创建错误

#### 🟡 传感器数据为unavailable
**错误现象：**
- 传感器显示为"不可用"状态

**处理步骤：**
1. **检查数据更新：**
```bash
# 查看HA日志
tail -f /config/home-assistant.log | grep sgcc_electricity

# 查看集成状态
# 在HA中进入 设置 → 设备与服务 → SGCC Electricity Client
```

2. **检查API数据：**
```bash
# 测试具体户号的API
curl http://localhost:8080/v1/electricity/balance/户号
curl http://localhost:8080/v1/electricity/this_year/户号
```

3. **重新加载集成：**
   - 在HA中删除集成
   - 重新添加集成
   - 或重启Home Assistant

#### 🔴 部分户号传感器缺失或显示异常
**错误现象：**
- HA页面可以加载户号列表
- 但只能显示个别户号信息
- 部分户号的传感器缺失或数据异常
- 某些户号显示"不可用"而其他正常

**根本原因分析：**
这是一个**关键的代码逻辑问题**，主要原因包括：

1. **API调用失败但未正确处理**：某些户号的API调用失败（如超时、404等），但代码继续执行
2. **数据结构不完整**：部分户号的数据获取失败导致`_data`字典中缺少必要的字段
3. **异步任务执行异常**：`asyncio.gather()`中某个任务失败影响整体数据结构
4. **传感器创建时数据不完整**：传感器创建时某些户号的数据字典缺少必要的键值

**需要检查的核心代码部分：**

**1. 数据获取逻辑 (`electricity.py` 第68-88行)：**
```python
async def async_get_data(self):
    try:
        user_list = await self.async_get_user_list()
        for user_id in user_list:
            if user_id not in self._data:
                self._data[user_id] = {}  # ⚠️ 关键：初始化数据结构
            tasks = [
                self.async_get_balance(user_id),
                self.async_get_dailys(user_id),
                self.async_get_latest_month(user_id),
                self.async_get_this_year(user_id)
            ]
            await asyncio.gather(*tasks)  # ⚠️ 问题点：任一失败影响整体
```

**2. 单个API调用逻辑 (`electricity.py` 第37-66行)：**
```python
async def async_get_balance(self, user_id):
    r = await self._session.get(BALANCE_URL.format(addr=self._addr, user_id=user_id), timeout=10)
    result = []
    if r.status == 200:  # ⚠️ 问题点：只处理200状态
        result = json.loads(await r.read())
    self._data[user_id]["balance"] = result['balance']  # ⚠️ 可能KeyError
```

**3. 传感器创建逻辑 (`sensor.py` 第71-74行)：**
```python
for user_id in coordinator.data.keys():  # ⚠️ 问题点：假设数据完整
    async_add_entities([
        ElectricitySensor(user_id, sensor_type, entry.entry_id, coordinator) 
        for sensor_type in SENSOR_TYPES
    ])
```

**详细排查和解决步骤：**

**步骤1：检查API响应状态**
```bash
# 逐一测试每个户号的API接口
for user_id in $(curl -s http://localhost:8080/v1/electricity/user_list | jq -r '.[]'); do
    echo "Testing user_id: $user_id"
    
    # 测试余额接口
    balance_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/v1/electricity/balance/$user_id)
    echo "  Balance API: $balance_status"
    
    # 测试年度数据接口
    year_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/v1/electricity/this_year/$user_id)
    echo "  Year API: $year_status"
    
    # 测试月度数据接口
    month_status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/v1/electricity/latest_month/$user_id)
    echo "  Month API: $month_status"
    
    echo "---"
done
```

**步骤2：检查API响应数据结构**
```bash
# 检查有问题的户号API响应
curl -v http://localhost:8080/v1/electricity/balance/有问题的户号

# 预期正确响应：
# {"balance": 123.45, "updateTime": "2024-01-01 12:00:00"}

# 可能的错误响应：
# HTTP 404 Not Found
# HTTP 500 Internal Server Error  
# {"error": "User not found"}
# 空响应 {}
```

**步骤3：检查HA集成日志**
```bash
# 查看详细的错误日志
tail -f /config/home-assistant.log | grep -E "(sgcc_electricity|KeyError|timeout|status)"

# 常见错误模式：
# KeyError: 'balance' - 数据字典缺少必要字段
# TimeoutError - API调用超时
# JSONDecodeError - 响应不是有效JSON
```

**步骤4：检查数据完整性**
在HA开发者工具中检查：
```python
# 进入开发者工具 → 模板
# 检查集成数据结构
{{ states.sensor | selectattr('entity_id', 'match', 'sensor.electricity_.*') | list | length }}

# 检查特定户号的传感器
{{ states | selectattr('entity_id', 'match', 'sensor.electricity_户号_.*') | list }}
```

**代码修复建议：**

**修复1：改进错误处理逻辑**
```python
# 在 electricity.py 中修改 async_get_balance 等方法
async def async_get_balance(self, user_id):
    try:
        r = await self._session.get(BALANCE_URL.format(addr=self._addr, user_id=user_id), timeout=10)
        if r.status == 200:
            result = json.loads(await r.read())
            self._data[user_id]["balance"] = result.get('balance', 0)
            self._data[user_id]["refresh_time"] = result.get('updateTime', 'unknown')
        else:
            LOGGER.warning(f"Balance API failed for {user_id}: HTTP {r.status}")
            self._data[user_id]["balance"] = None
            self._data[user_id]["refresh_time"] = 'unavailable'
    except Exception as e:
        LOGGER.error(f"Balance API error for {user_id}: {e}")
        self._data[user_id]["balance"] = None
        self._data[user_id]["refresh_time"] = 'error'
```

**修复2：改进数据获取逻辑**
```python
# 在 electricity.py 中修改 async_get_data 方法
async def async_get_data(self):
    try:
        user_list = await self.async_get_user_list()
        LOGGER.debug(f"user_list: {user_list}")

        for user_id in user_list:
            if user_id not in self._data:
                # 初始化完整的数据结构
                self._data[user_id] = {
                    "balance": None,
                    "year_ele_num": None,
                    "year_ele_cost": None,
                    "last_month_ele_num": None,
                    "last_month_ele_cost": None,
                    "refresh_time": None,
                    "dailys": []
                }
            
            # 分别处理每个API调用，避免一个失败影响全部
            try:
                await self.async_get_balance(user_id)
            except Exception as e:
                LOGGER.error(f"Failed to get balance for {user_id}: {e}")
                
            try:
                await self.async_get_this_year(user_id)
            except Exception as e:
                LOGGER.error(f"Failed to get year data for {user_id}: {e}")
                
            # ... 其他API调用类似处理
                
        LOGGER.debug(f"Final data structure: {json.dumps(self._data)}")
        await async_save_to_store(self._hass, CONFIG_NAME, self._data)
    except Exception as err:
        traceback.print_exc()
        LOGGER.error(f"get data error: {err}")
    return self._data
```

**临时解决方案：**

**方案1：重置集成数据**
```bash
# 停止HA
sudo systemctl stop home-assistant@homeassistant.service

# 删除集成存储的数据
rm /config/.storage/sgcc_electricity_client_*

# 重启HA
sudo systemctl start home-assistant@homeassistant.service

# 重新添加集成
```

**方案2：手动检查和修复**
```bash
# 1. 确认所有户号的Web API都正常
for user_id in $(curl -s http://localhost:8080/v1/electricity/user_list | jq -r '.[]'); do
    echo "Checking $user_id..."
    curl -s http://localhost:8080/v1/electricity/balance/$user_id | jq .
done

# 2. 如果某个户号API异常，检查Web服务日志
docker-compose logs sgcc_electricity_web | grep "户号"

# 3. 临时忽略有问题的户号
# 在Web服务config.yaml中添加：
electricity:
  ignore_user_id: 
    - "有问题的户号"
```

**预防措施：**
1. 在Web服务中添加API健康检查
2. 在HA集成中添加数据完整性验证
3. 设置更详细的日志记录
4. 定期检查传感器状态

---

## 🛠️ 系统监控和预防

### 1. 日志监控设置

#### Web服务日志监控
```yaml
# 在config.yaml中设置详细日志
logger:
  level: "DEBUG"  # 临时启用调试日志
```

```bash
# 实时监控日志
docker-compose logs -f sgcc_electricity_web

# 过滤错误日志
docker-compose logs sgcc_electricity_web | grep -E "(ERROR|CRITICAL|failed)"
```

#### Home Assistant日志监控
```yaml
# 在configuration.yaml中添加
logger:
  default: warning
  logs:
    custom_components.sgcc_electricity_client: debug
```

### 2. 健康检查脚本

创建监控脚本 `health_check.sh`：
```bash
#!/bin/bash

WEB_SERVICE_URL="http://localhost:8080"
LOG_FILE="/tmp/sgcc_health.log"

echo "$(date): Starting health check" >> $LOG_FILE

# 检查Web服务状态
if curl -f -s "$WEB_SERVICE_URL/v1/electricity/user_list" > /dev/null; then
    echo "$(date): Web service OK" >> $LOG_FILE
else
    echo "$(date): Web service ERROR" >> $LOG_FILE
    # 发送告警通知
    # curl -X POST "https://api.pushover.net/1/messages.json" ...
fi

# 检查用户数据
USER_COUNT=$(curl -s "$WEB_SERVICE_URL/v1/electricity/user_list" | jq length)
if [ "$USER_COUNT" -gt 0 ]; then
    echo "$(date): User data OK ($USER_COUNT users)" >> $LOG_FILE
else
    echo "$(date): User data ERROR (no users found)" >> $LOG_FILE
fi
```

### 3. 自动化告警配置

在Home Assistant中创建自动化：
```yaml
automation:
  - alias: "电费监控服务异常告警"
    trigger:
      - platform: state
        entity_id: sensor.electricity_户号_refresh_time
        to: "unavailable"
        for:
          minutes: 30
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "电费监控异常"
          message: "电费数据超过30分钟未更新，请检查服务状态"
          
  - alias: "电费服务恢复通知"
    trigger:
      - platform: state
        entity_id: sensor.electricity_户号_refresh_time
        from: "unavailable"
    action:
      - service: notify.mobile_app_your_phone
        data:
          title: "电费监控恢复"
          message: "电费数据监控服务已恢复正常"
```

---

## 🔧 常用故障排除命令

### 部分户号显示异常快速诊断脚本

创建诊断脚本 `diagnose_partial_users.sh`：
```bash
#!/bin/bash

WEB_SERVICE_URL="http://localhost:8080"
echo "=== 国家电网电费监控 - 部分户号异常诊断 ==="
echo "时间: $(date)"
echo

# 1. 检查Web服务状态
echo "1. 检查Web服务状态..."
if curl -f -s "$WEB_SERVICE_URL/v1/electricity/user_list" > /dev/null; then
    echo "✅ Web服务运行正常"
else
    echo "❌ Web服务无响应，请先解决Web服务问题"
    exit 1
fi

# 2. 获取户号列表
echo -e "\n2. 获取户号列表..."
USER_LIST=$(curl -s "$WEB_SERVICE_URL/v1/electricity/user_list")
if [ "$USER_LIST" = "[]" ]; then
    echo "❌ 户号列表为空，请检查Web服务数据抓取"
    exit 1
fi

echo "发现户号: $USER_LIST"
USER_ARRAY=$(echo $USER_LIST | jq -r '.[]')

# 3. 逐个测试户号API
echo -e "\n3. 测试各户号API接口..."
PROBLEM_USERS=()

for user_id in $USER_ARRAY; do
    echo "测试户号: $user_id"
    
    # 测试余额API
    balance_response=$(curl -s -w "HTTP_CODE:%{http_code}" "$WEB_SERVICE_URL/v1/electricity/balance/$user_id")
    balance_code=$(echo "$balance_response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
    balance_data=$(echo "$balance_response" | sed 's/HTTP_CODE:[0-9]*$//')
    
    if [ "$balance_code" != "200" ]; then
        echo "  ❌ 余额API失败 (HTTP $balance_code)"
        PROBLEM_USERS+=("$user_id")
        continue
    fi
    
    # 检查余额数据结构
    if ! echo "$balance_data" | jq -e '.balance' > /dev/null 2>&1; then
        echo "  ❌ 余额数据结构异常: $balance_data"
        PROBLEM_USERS+=("$user_id")
        continue
    fi
    
    # 测试年度数据API
    year_response=$(curl -s -w "HTTP_CODE:%{http_code}" "$WEB_SERVICE_URL/v1/electricity/this_year/$user_id")
    year_code=$(echo "$year_response" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
    
    if [ "$year_code" != "200" ]; then
        echo "  ⚠️  年度数据API失败 (HTTP $year_code)"
        # 年度数据失败不算严重问题，但需要记录
    fi
    
    echo "  ✅ 户号 $user_id API正常"
done

# 4. 输出诊断结果
echo -e "\n4. 诊断结果汇总..."
if [ ${#PROBLEM_USERS[@]} -eq 0 ]; then
    echo "✅ 所有户号API测试通过"
    echo "问题可能在HA集成端，建议："
    echo "  - 重启Home Assistant"
    echo "  - 删除并重新添加集成"
    echo "  - 检查HA日志: tail -f /config/home-assistant.log | grep sgcc"
else
    echo "❌ 发现问题户号: ${PROBLEM_USERS[*]}"
    echo "建议处理方案:"
    echo "  1. 检查Web服务日志: docker-compose logs sgcc_electricity_web | grep '${PROBLEM_USERS[0]}'"
    echo "  2. 临时忽略问题户号，在config.yaml中添加:"
    echo "     electricity:"
    echo "       ignore_user_id:"
    for user in "${PROBLEM_USERS[@]}"; do
        echo "         - \"$user\""
    done
    echo "  3. 重启Web服务: docker-compose restart"
fi

# 5. 检查HA传感器状态（如果可访问）
echo -e "\n5. 检查Home Assistant传感器状态..."
if command -v ha &> /dev/null; then
    echo "检查电费传感器..."
    ha states list | grep "sensor.electricity_" | wc -l | xargs echo "传感器总数:"
    
    unavailable_count=$(ha states list | grep "sensor.electricity_" | grep "unavailable" | wc -l)
    echo "不可用传感器数: $unavailable_count"
    
    if [ "$unavailable_count" -gt 0 ]; then
        echo "不可用传感器列表:"
        ha states list | grep "sensor.electricity_" | grep "unavailable"
    fi
else
    echo "无法直接访问HA CLI，请手动检查传感器状态"
fi

echo -e "\n=== 诊断完成 ==="
```

使用方法：
```bash
chmod +x diagnose_partial_users.sh
./diagnose_partial_users.sh
```

### Web服务诊断
```bash
# 完整服务状态检查
docker-compose ps
docker-compose logs --tail=50 sgcc_electricity_web

# API接口测试
curl -v http://localhost:8080/v1/electricity/user_list
curl -v http://localhost:8080/v1/electricity/balance/户号

# 数据库检查
docker exec -it container_name sqlite3 /config/homeassistant.db
.tables
SELECT user_code, balance, update_time FROM user_info;
.exit

# 配置文件验证
python -c "import yaml; print(yaml.safe_load(open('config.yaml')))"
```

### Home Assistant集成诊断
```bash
# 检查组件文件
ls -la /config/custom_components/sgcc_electricity_client/

# 检查HA日志
tail -f /config/home-assistant.log | grep sgcc

# 重启相关服务
sudo systemctl restart home-assistant@homeassistant.service

# 检查网络连接
curl -I http://web_service_host:8080
```

### 网络和权限检查
```bash
# 端口检查
sudo netstat -tlnp | grep 8080
sudo ss -tlnp | grep 8080

# 防火墙检查
sudo ufw status
sudo iptables -L

# 权限检查
ls -la /config/custom_components/
ls -la /path/to/web/service/config.yaml
```

---

## 📞 获取帮助

### 日志收集
当需要寻求帮助时，请收集以下信息：

1. **Web服务日志：**
```bash
docker-compose logs sgcc_electricity_web > web_service.log
```

2. **Home Assistant日志：**
```bash
grep -A 10 -B 10 "sgcc_electricity" /config/home-assistant.log > ha_integration.log
```

3. **系统信息：**
```bash
# 系统版本
cat /etc/os-release

# Docker版本
docker --version
docker-compose --version

# HA版本
# 在HA界面查看：设置 → 系统 → 修复
```

4. **配置信息（脱敏后）：**
```yaml
# config.yaml（移除敏感信息）
electricity:
  phone_number: "138****8000"  # 脱敏处理
  password: "****"            # 脱敏处理
  # 其他配置...
```

### 社区支持
- GitHub Issues: 项目仓库的Issues页面
- Home Assistant社区: community.home-assistant.io
- 相关论坛和技术群组

---

## 📋 错误处理检查清单

### 部署前检查
- [ ] Docker环境正常
- [ ] 网络能访问国家电网官网
- [ ] 配置文件格式正确
- [ ] 账号密码有效
- [ ] 端口未被占用

### 运行时监控
- [ ] Web服务日志无错误
- [ ] API接口响应正常
- [ ] 数据库有用户数据
- [ ] HA集成加载成功
- [ ] 传感器数据正常更新

### 故障恢复
- [ ] 备份重要配置和数据
- [ ] 记录错误日志和现象
- [ ] 按预案逐步排查
- [ ] 验证修复效果
- [ ] 更新监控配置

---

**记住：大多数错误都是由配置问题、网络问题或时序问题引起的。按照本预案逐步排查，通常都能找到解决方案。如果问题持续存在，请收集详细日志并寻求社区帮助。**

🎯 **预案使用提示：**
1. 遇到错误时，先查看对应的错误分类
2. 按照处理步骤逐一执行
3. 记录处理过程和结果
4. 如果问题解决，考虑更新监控配置预防再次发生
5. 如果问题未解决，收集日志寻求帮助
